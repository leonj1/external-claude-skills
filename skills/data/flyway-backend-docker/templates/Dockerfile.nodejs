FROM node:24-alpine

# Install tini and dependencies for flyway
RUN apk add --no-cache tini openjdk17-jre-headless wget curl bash netcat-openbsd

# Install Flyway with retry logic
ENV FLYWAY_VERSION=10.22.0
RUN mkdir -p /tmp/flyway && \
    curl -fSL --retry 3 --retry-delay 5 \
        "https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${FLYWAY_VERSION}/flyway-commandline-${FLYWAY_VERSION}-linux-alpine-x64.tar.gz" \
        -o /tmp/flyway/flyway.tar.gz && \
    tar -xzf /tmp/flyway/flyway.tar.gz -C /opt && \
    ln -s /opt/flyway-${FLYWAY_VERSION}/flyway /usr/local/bin/flyway && \
    rm -rf /tmp/flyway

WORKDIR /app

# Copy SQL migrations
COPY sql/ /app/sql/

# Copy package files and install
COPY package*.json ./
RUN npm ci --only=production

# Copy entrypoint
COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# Copy application code
COPY . .

EXPOSE 3000

# Use tini as init, entrypoint runs flyway then app
ENTRYPOINT ["/sbin/tini", "--", "/docker-entrypoint.sh"]
CMD ["node", "dist/index.js"]
